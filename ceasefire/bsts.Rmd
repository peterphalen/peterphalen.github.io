---
title: "Modeling shootings and the ceasefire effect using bayesian structural / state space time series model"
author: "peter phalen"
date: "4/17/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In [this markdown](https://www.peterphalen.com/ceasefire/) I modeled shootings in Baltimore (from 2012-present) using a Bayesian generalized additive model. This has a lot of benefits mostly in terms of the ease of interpreting the model components and the ease of writing up the model (e.g., fitting a cubic spline is apparently equivalent to fitting a univariate local linear trend model using a Kalman filter). However, the approach is slightly non-standard in the time series literature. So, I wanted to redo everything with a state-space model, coded up in Stan, to show the similarity of the results.

First we process all the data.
```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(rstan)
library(lubridate)
require(ggfortify)
library(scales)
library(bayesplot)

# data came from here: https/:/data.baltimorecity.gov/Public-Safety/BPD-Part-1-Victim-Based-Crime-Data/wsfq-mvij/data
# but I'm loading a copy that I backed up on github
bpd <- read_csv("https://raw.githubusercontent.com/peterphalen/ceasefire/master/BPD_Part_1_Victim_Based_Crime_Data.csv")

# subset to shootings or homicides with a firearm
bpd <- subset(bpd, Description == "SHOOTING" |
                (Description == "HOMICIDE" & Weapon == "FIREARM"))

bpd$CrimeDate <- as.Date(bpd$CrimeDate, format = "%m/%d/%Y")

# there are many crimes per day. collapse to daily counts
daily <- bpd %>% group_by(CrimeDate) %>% summarise(shootings = n())

# fill missing dates, because some had no shootings
full.ts <- data.frame(CrimeDate = seq(daily$CrimeDate[1], 
                                      daily$CrimeDate[nrow(daily)], by="day"))
daily <- full_join(full.ts,daily)
daily <- daily %>% group_by(CrimeDate) %>% mutate_all(funs(ifelse(is.na(.),0,.)))
```

The time series looks like this:

```{r}
ggplot(daily) +
  aes(x=CrimeDate, y=shootings) +
  geom_point(alpha=.2) + 
  xlab("date") +
  ylab("shootings") +
  scale_y_continuous(breaks=c(0,4,8,12)) +
  scale_x_date(labels = date_format("%b %Y")) +
  ggtitle(" ", 
          subtitle="Baltimore (2012-present)")
```

We define variables for day of the week (1-7) and week of the year (1-53) and a dummy code for ceasefire.
```{r}
daily$weekday <- factor(weekdays(daily$CrimeDate),
                        levels=c("Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"))

daily$day.of.year <- yday(daily$CrimeDate)
daily$week.of.year <- week(daily$CrimeDate)

ceasefire.initial <- 
  as.Date(
    c("08/04/2017",
      "11/03/2017",
      "02/02/2018",
      "05/11/2018",
      "08/03/2018",
      "11/02/2018",
      "02/01/2019",
      "05/10/2019"),
    format="%m/%d/%Y")

ceasefire.weekends <- 
  lapply(ceasefire.initial,
         function(x){
           seq(from=x,
               by="day",
               length.out=3)})

ceasefire.weekends <- do.call("c", 
                              ceasefire.weekends)

# dummy variable
daily$ceasefire <- ifelse(daily$CrimeDate %in% ceasefire.weekends, 1, 0)

```

Code up a bayesian structural time series model. (see https://github.com/sinhrks/stan-statespace for examples of these)

This model has an autoregressive stochastic level and slope, accounts for weekly and yearly seasonality, and includes a dummy code for the ceasefire.

```{r}
# stochastic level (mu) and slope (v)
model_code <- "data {
  int<lower=1> n;
  int y[n];
  int J;
  int<upper=7> weekday[n];
  int<lower=1,upper=J> week_of_year[n];
  int<lower=0,upper=1> ceasefire[n];
}
parameters {
  vector[n] mu;
  vector[n-1] v;
  vector[7] weekday_effect;
  vector[J] week_of_year_effect;
  real ceasefire_effect;
  real<lower=0> sigma_weekday;
  real<lower=0> sigma_drift;
  real<lower=0> sigma_level;
  real<lower=0> sigma_woy;
}
transformed parameters {
  vector[n] yhat;
  for(t in 1:n) {
    yhat[t] = mu[t] + ceasefire_effect * ceasefire[t];
  }
}
model {
  week_of_year_effect ~ normal(0,sigma_woy);
  sigma_woy ~ normal(0,2);
  weekday_effect ~ normal(0,sigma_weekday);
  sigma_weekday ~ normal(0,2);

  for(t in 2:n)
    mu[t] ~ normal(mu[t-1] + v[t-1], sigma_level);
  for(t in 2:n-1)
    v[t] ~ normal(v[t-1], sigma_drift);
  for(t in 1:n)
    y[t] ~ poisson_log(yhat[t] + weekday_effect[weekday[t]] + week_of_year_effect[week_of_year[t]]);
}"

```

Stan takes data as a list.
```{r}
stan_data <- list(y <- daily$shootings,
                  n <- nrow(daily),
                  weekday <- as.numeric(daily$weekday),
                  J <- max(daily$week.of.year),
                  ceasefire <- daily$ceasefire,
                  week_of_year <- daily$week.of.year)
```

Fit the model:
```{r}
fit <- stan(model_code=model_code, data=stan_data, cores=4, chains=4, iter = 500, control=list(adapt_delta=.9,max_treedepth=20))
```

Here's the trend plotted over the data:
```{r}
mu <- exp(get_posterior_mean(fit, pars="yhat")[, 'mean-all chains'])

y <- ts(daily$shootings, start = c(2012, 1), frequency = 365)

p <- autoplot(y, alpha=.2)
yhat <- ts(mu, start = start(y), frequency = frequency(y))
p <- autoplot(yhat, p = p, ts.colour="blue")
p
```

You can already see the ceasefire effect as those little blue downward spikes in the far right of the series, but here is the estimated effect plotted directly as an odds ratio:

```{r, message=FALSE, warning=FALSE}
ceasefire.effect <- as.array(fit, pars = "ceasefire_effect") 
# scale to an odds ratio by exponentiating
ceasefire.effect <- exp(ceasefire.effect)
mcmc_intervals(ceasefire.effect) + 
  xlab("odds ratio") +
  xlim(c(0,1))
```

Despite the very different model specification, this finding matches the [GAM model](https://www.peterphalen.com/ceasefire/) almost perfectly.


